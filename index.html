<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Countdown Timer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #000000;
            overflow: hidden;
        }
        
        #countdown {
            color: #FFFFFF;
            font-size: 60vw;
            font-weight: bold;
            text-align: center;
            line-height: 1;
            margin: 0;
            padding: 0;
        }
        
        .warning {
            animation: flash 0.5s ease infinite;
        }
        
        @keyframes flash {
            0% { color: #FFFFFF; }
            50% { color: #FF0000; }
            100% { color: #FFFFFF; }
        }
        
        #controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            padding: 10px;
        }
        
        button {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #007AFF;
            color: white;
            border: none;
            border-radius: 10px;
            margin: 0 10px;
        }
        
        #debugInfo {
            position: fixed;
            bottom: 5px;
            left: 5px;
            font-size: 10px;
            color: gray;
            z-index: 1000;
        }
        
        .display-mode #controls {
            display: none;
        }
    </style>
</head>
<body>
    <div id="countdown">10</div>
    
    <div id="controls">
        <button id="startButton">Start Countdown</button>
        <button id="resetButton">Reset</button>
        <button id="generateLinkButton">Generate Display Link</button>
    </div>
    
    <div id="debugInfo"></div>

    <script>
        // Debug output
        const debugInfoElement = document.getElementById('debugInfo');
        
        function showDebug(message) {
            if (debugInfoElement) {
                debugInfoElement.innerHTML += message + '<br>';
                // Limit debug messages to the last 10
                const lines = debugInfoElement.innerHTML.split('<br>');
                if (lines.length > 10) {
                    debugInfoElement.innerHTML = lines.slice(lines.length - 10).join('<br>');
                }
            }
        }
        
        // Timer functionality
        let countdown = 10;
        let timer;
        let isRunning = false;
        let startTime = 0;
        
        const countdownElement = document.getElementById('countdown');
        const startButton = document.getElementById('startButton');
        const resetButton = document.getElementById('resetButton');
        const generateLinkButton = document.getElementById('generateLinkButton');
        
        // Check URL parameters
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // Check if this is display mode
            if (urlParams.get('mode') === 'display') {
                document.body.classList.add('display-mode');
                showDebug("Display mode active");
            }
            
            // Check for a start command with timestamp
            const startParam = urlParams.get('start');
            if (startParam) {
                const startTimestamp = parseInt(startParam);
                startTime = startTimestamp;
                
                // Calculate how many seconds have passed since the start command
                const secondsElapsed = Math.floor((Date.now() - startTimestamp) / 1000);
                
                if (secondsElapsed < 10) {
                    // Start countdown with adjusted time
                    countdown = 10 - secondsElapsed;
                    startCountdownAt(countdown);
                    showDebug(`Starting countdown at ${countdown} (${secondsElapsed}s elapsed)`);
                } else {
                    showDebug("Start command expired");
                    resetCountdown();
                }
            }
        }
        
        function updateDisplay() {
            countdownElement.textContent = countdown;
            
            // Add warning class for final 3 seconds
            if (countdown <= 3) {
                countdownElement.classList.add('warning');
            } else {
                countdownElement.classList.remove('warning');
            }
        }
        
        function startCountdown() {
            if (isRunning) return;
            
            // Set start time
            startTime = Date.now();
            startCountdownAt(10);
            
            // Update URL for display device to sync with
            if (window.history && window.history.replaceState) {
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('start', startTime);
                window.history.replaceState({}, '', newUrl);
                showDebug(`URL updated with start=${startTime}`);
            }
        }
        
        function startCountdownAt(startSeconds) {
            if (isRunning) return;
            
            isRunning = true;
            countdown = startSeconds;
            updateDisplay();
            
            timer = setInterval(() => {
                countdown--;
                updateDisplay();
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    isRunning = false;
                    setTimeout(() => {
                        resetCountdown();
                    }, 1000);
                }
            }, 1000);
        }
        
        function resetCountdown() {
            clearInterval(timer);
            isRunning = false;
            countdown = 10;
            updateDisplay();
            
            // Update URL to remove start parameter
            if (window.history && window.history.replaceState) {
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.delete('start');
                window.history.replaceState({}, '', newUrl);
                showDebug("URL reset");
            }
        }
        
        // Generate a sharable link for the display
        function generateDisplayLink() {
            const baseUrl = window.location.href.split('?')[0];
            const displayUrl = `${baseUrl}?mode=display`;
            
            // Create temporary input for copying
            const tempInput = document.createElement('input');
            document.body.appendChild(tempInput);
            tempInput.value = displayUrl;
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            
            showDebug(`Display link copied to clipboard: ${displayUrl}`);
            alert("Display link copied to clipboard!\n\nOpen this link on your iPad. Then press Start on this device to control the countdown.");
        }
        
        // Event listeners
        startButton.addEventListener('click', startCountdown);
        resetButton.addEventListener('click', resetCountdown);
        generateLinkButton.addEventListener('click', generateDisplayLink);
        
        // Check for URL parameters on page load
        checkUrlParams();
        
        // Refresh sync every few seconds to stay in sync
        setInterval(() => {
            if (startTime > 0 && isRunning) {
                const secondsElapsed = Math.floor((Date.now() - startTime) / 1000);
                const expectedCount = 10 - secondsElapsed;
                
                // If our countdown is off by more than 1 second, adjust it
                if (Math.abs(countdown - expectedCount) > 1 && expectedCount > 0) {
                    countdown = expectedCount;
                    updateDisplay();
                    showDebug(`Re-synced countdown to ${countdown}`);
                }
            }
        }, 2000);
    </script>
</body>
</html>
